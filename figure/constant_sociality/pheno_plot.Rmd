---
title: "plot phenotype data for multiple models"
author: "Andrea Chen"
date: "`r Sys.Date()`"
output: pdf_document
---

# parameters for plotting
```{r setup, include=FALSE}
wd_path <- normalizePath(dirname(rstudioapi::getActiveDocumentContext()$path))
setwd(wd_path)
base_plot_folder <- "../plots/11_11"
hcl_color_palette <- "Dark 2" # color pattern for lines 
regimes <- c("fit", "ext", "ave")  # only fittest model has phenotype
num_bins <- 120 # number of bins for histogram (bin range from -num_bins/2 to num_bins/2)
gen_seq = seq(10000, 10100, by = 10) # generations to plot
single_panel <- FALSE # single plot with multiple psi values, only works for single generation plotting
```

# load phenotype data
```{r}
pheno_df <- readRDS("../r_data/phenotype_data.rds")
```

```{r}
pheno_df <- phenotype_df
```

# parameter space for data
## all psi values to plot for fittest model
plot_psi <- c(0.0, 0.1, 0.3, 0.5, 0.7, 0.9, 1.0) 
## all group sizes
plot_n <- c(2, 8, 20, 50)
## all shift sizes 
plot_shift_sizes <- c(40,80,120) 
## all generations
gen_seq = c(seq(9999, 10010, by = 1), seq(10010, 10100, by=10)) # generations to plot


# change parameters here for plotting a subset of the data
## PARAMETER: single panel single generation plot
```{r}
plot_psi <- c(0.0, 0.9)
plot_n <- c(50)
plot_shift_sizes <- c(120)
num_bins <- 120
gen_seq = seq(9999, 9999, by = 1)
single_panel <- TRUE
```

## PARAMETER: single panel multi generation plot
```{r setup, include=FALSE}
param_val <- c(0.0, 0.01, 0.03, 0.05, 0.07, 0.3, 0.5, 0.7, 0.9, 1.0) # all beta values to plot for inverse-variance model
plot_n <- c(2, 8, 20, 50) # group sizes to plot for both models
plot_shift_sizes <- c(40,80,120) # shift sizes to plot for both models
regimes <- c("inv")  # "inv" = inverse variance model, "fit" = fittest individual model
single_panel <- TRUE  
num_bins <- 100
gen_seq = c(9999, seq(10000, 10030, by = 10))
```

```{r setup, include=FALSE}
param_val <- c(0.0, 0.5, 0.9) 
plot_n <- c(2, 8, 20, 50) # group sizes to plot for both models
plot_shift_sizes <- c(40,80,120) # shift sizes to plot for both models
regimes <- c("fit")  # "inv" = inverse variance model, "fit" = fittest individual model
single_panel <- TRUE  
num_bins <- 100
gen_seq = seq(9999, 9999, by = 1)
```

```{r setup, include=FALSE}
param_val <- c(0.0, 0.1, 0.3, 0.5, 0.7, 0.9, 1.0) 
plot_n <- c(2, 8, 20, 50) # group sizes to plot for both models
plot_shift_sizes <- c(40,80,120) # shift sizes to plot for both models
regimes <- c("ave")  # "inv" = inverse variance model, "fit" = fittest individual model
single_panel <- TRUE  
num_bins <- 140
gen_seq = c(9999, seq(10000, 10030, by = 10))
```

```{r setup, include=FALSE}
param_val <- c(0.0, 0.1, 0.3, 0.5, 0.7, 0.9, 1.0) 
plot_n <- c(2, 8, 20, 50) # group sizes to plot for both models
plot_shift_sizes <- c(40,80,120) # shift sizes to plot for both models
regimes <- c("ext")  # "inv" = inverse variance model, "fit" = fittest individual model
single_panel <- TRUE  
num_bins <- 140
gen_seq = c(9999, seq(10000, 10030, by = 10))
```

# PARAMETER: multi panel multi generation plot
```{r}
plot_psi <- c(0.0, 0.9)
plot_n <- c(50)
plot_shift_sizes <- c(120)
num_bins <- 120
gen_seq = seq(9999, 10010, by = 1)
single_panel <- FALSE
```

# RUN PLOTTING after change the parameters above
```{r}
min_bin <- -as.integer(num_bins/2)
max_bin <- as.integer(num_bins/2)
bin_breaks <- seq(min_bin, max_bin, length.out = num_bins + 1)

# Derive a constant bin width from your reference breaks
bin_width <- (max(bin_breaks) - min(bin_breaks)) / num_bins
half_span <- (num_bins * bin_width) / 2

if (regimes != "inv") {
  plot_psi <- param_val
} else {
  plot_beta <- param_val
}

# ---- Run ----
plot_phenotype_multi(
  pheno_df,
  out_subfolder = paste0("phenotype_overtime_", paste0(c(min(gen_seq), max(gen_seq)), collapse = ":")),
  gen_seq = gen_seq,
  num_bins = num_bins,
  bin_width = bin_width,
  half_span = half_span,
  regimes = regimes,
  single_panel = single_panel
)
```




```{r}
breaks_vec <- seq(-40, 80, by = 1)   # values outside [-5,5] are ignored
reg = "ave"
n=8
shift_size = 20
gen=9999
filt_A <- list(reg=reg, n=n, psi=0, shift_size=shift_size)
filt_B <- list(reg=reg, n=n, psi=0.5, shift_size=shift_size)
filt_C <- list(reg=reg, n=n, psi=0.9, shift_size=shift_size)


png(file.path(base_plot_folder, paste0("pheno_", gen, "/", reg, "_", shift_size,"_", n, ".png")), width=2200, height=1500, res=150)
par(cex.axis = 1.6, cex.lab = 2.0, cex.main = 1.0, mar = c(4.5, 6, 3, 1) + 0.1)
                
plot_hist_lines_multi(
  df = pheno_df,
  filters = list(filt_A, filt_B, filt_C),
  generation = gen,
  breaks = breaks_vec,
  labels = list(title = paste0("pheno_", gen, "/", reg, "_", shift_size,"_", n, "opt = ", shift_size),
                x = "Phenotype value", y = "Proportion"),
  show_rep = FALSE,
  ymax = 0.1,
  lwd = 4,
  cols = c(hcl.colors(3, "Dark 2", rev = FALSE)[1], hcl.colors(3, "Dark 2", rev = FALSE)[2], hcl.colors(3, "Dark 2", rev = FALSE)[3])
)
leg_expr <- as.expression(lapply(c(filt_A$psi, filt_B$psi, filt_C$psi), function(v) bquote(psi == .(v))))
                
legend("topright", bty = "n",
        legend = leg_expr,
       col = c(hcl.colors(3, "Dark 2", rev = FALSE)[1],hcl.colors(3, "Dark 2", rev = FALSE)[2], hcl.colors(3, "Dark 2", rev = FALSE)[3]),
        lwd = 4, cex=2.2)
dev.off()

```