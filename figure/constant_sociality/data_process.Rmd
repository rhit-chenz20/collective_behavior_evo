---
title: "plot genotype, phenotype data for multiple models"
author: "Andrea Chen"
date: "`r Sys.Date()`"
output: pdf_document
---

## evolving sociality data
```{r setup, include=FALSE}
wd_path <- normalizePath(dirname(rstudioapi::getActiveDocumentContext()$path))
setwd(wd_path)
base_data_folders <- c("../../data/fluctuate_env_constant_psi")
regimes <- c("inv", "fit", "ave", "ext")  # "inv" = inverse_variance, "var" = variance

# ---- Helper: choose the generation key column name ----
.gen_key <- function(d) {
  if ("tick" %in% names(d)) return("tick")
  if ("generation" %in% names(d)) return("generation")
  names(d)[1]
}
```

# load SUMMARY STATS data
```{r}
# Top-level folder
folders <- file.path(base_data_folders, "data")

extract_sum_metadata <- function(path) {
    rx <- "n_(\\d+)_(psi|beta)_(-?[0-9.]+)_sz_(\\d+)_reg_(inv|fit|ext|ave)_(\\d+)\\.tsv"
    m  <- regexec(rx, path)
    p  <- regmatches(path, m)[[1]]

    if (length(p) != 7) {
        # Try to extract the reg part manually (for logging or skipping)
        reg_match <- sub(".*_reg_([a-zA-Z0-9]+)_\\d+\\.tsv$", "\\1", path)
        
        # If the reg is not one of the regimes you care about, just skip silently
        if (!reg_match %in% regimes) return(data.frame())

        # Otherwise, keep the warning for genuine regex mismatches
        warning("Could not extract metadata from path: ", path,
                " with match: ", paste(p, collapse = ", "))
        return(data.frame())
    }
    
    data.frame(
        n          = as.integer(p[2]),
        var = p[3],
        value      = as.numeric(p[4]),
        shift_size = as.integer(p[5]),
        reg        = p[6],               
        rep        = as.integer(p[7]),
        file_id    = basename(path),
        stringsAsFactors = FALSE
    )
}

dfs <- lapply(folders, function(folder) {
    if (!dir.exists(folder)) {
        warning("Folder does not exist: ", folder)
        next
    }

    file_list <- list.files(
        path = folder,
        pattern = "\\.tsv$",
        full.names = TRUE,
        recursive = TRUE
    )

    # Read and combine all files
    stat_df <- do.call(rbind, lapply(file_list, function(file) {
        df <- tryCatch(read.table(file, header = TRUE, sep = "\t", check.names = FALSE),
                    error = function(e) NULL)
        if (is.null(df)) {
            warning("Failed to read: ", file)
            return(NULL)
        }

        meta <- extract_sum_metadata(file)
        if (nrow(meta) == 0) return(NULL)
      if (meta$var == "beta"){
        df$psi = NA
        df$beta = meta$value
      } 
      if (meta$var == "psi"){
        df$beta = NA
        df$psi = meta$value
      } 

        # # Attach metadata columns
        df$n          <- meta$n
        df$shift_size <- meta$shift_size
        df$reg        <- meta$reg
        df$rep        <- meta$rep
        df$file_id    <- meta$file_id

        df
    }))
    stat_df <- stat_df[ , sort(names(stat_df))]
   
    return(stat_df)
})

summary_stat_df <- do.call(rbind, dfs)
```



```{r}
unique(colnames(summary_stat_df))
unique(summary_stat_df[summary_stat_df$reg == "inv" & summary_stat_df$psi == 0.5, ]$rep)
```



```{r}
# Save
saveRDS(summary_stat_df, file = "../r_data/fluc_env_cpsi/data_summary.rds")
```

```{r}
# Later (or on another machine)
data_df <- readRDS("../r_data/fluc_env_cpsi/summary.rds")
```

```{r}
print(unique(summary_stat_df$reg))
```

# load genotype data
```{r}
# Top-level folders to search under
folders <- file.path(base_data_folders, "genotype")

# ---- Metadata extractor for genotype paths ----
# Matches: genotype/n_<n>_(beta|psi)_<val>_sz_<sz>_reg_(inv|fit|ext|ave)_<rep>.tsv
extract_geno_metadata <- function(path) {
  pat <- "genotype/n_(\\d+)_psi_(-?[0-9.]+)_sz_(\\d+)_reg_(inv|fit|ext|ave)_(\\d+)\\.tsv$"
  matches <- regexec(pat, path)
  parts <- regmatches(path, matches)[[1]]

  if (length(parts) != 6) {
    reg_match <- sub(".*_reg_([a-zA-Z0-9]+)_\\d+\\.tsv$", "\\1", path)
    if (!exists("regimes") || !reg_match %in% regimes) return(data.frame())
    warning("Could not extract metadata from path: ", path,
            " with matches: ", paste(parts, collapse = ", "))
    return(data.frame())
  }

  data.frame(
    n          = as.integer(parts[2]),          # "beta" or "psi"
    psi      = as.numeric(parts[3]),
    shift_size = as.integer(parts[4]),
    reg        = parts[5],                 # "inv"|"fit"|"ext"|"ave"
    rep        = as.integer(parts[6]),
    file_id    = basename(path),
    stringsAsFactors = FALSE
  )
}

dfs <- lapply(folders, function(folder) {
  if (!dir.exists(folder)) {
    warning("Folder does not exist: ", folder)
    return(NULL)
  }

  file_list <- list.files(
    path = folder,
    pattern = "\\.tsv$",
    full.names = TRUE,
    recursive = TRUE
  )
  if (!length(file_list)) return(NULL)

  geno_df <- do.call(rbind, lapply(file_list, function(file) {
    # Read genotype file
    df <- tryCatch(read.table(file, header = TRUE, sep = "\t", check.names = FALSE),
                   error = function(e) NULL)
    if (is.null(df)) {
      warning("Failed to read genotype: ", file)
      return(NULL)
    }

    meta <- extract_geno_metadata(file)
    if (nrow(meta) == 0) return(NULL)

    # Attach metadata columns
    df$n <- meta$n
    df$psi  <- meta$psi
    df$shift_size <- meta$shift_size
    df$reg        <- meta$reg
    df$rep        <- meta$rep
    df$file_id    <- meta$file_id

    df
  }))

  geno_df
})

genotype_df <- do.call(rbind, dfs)

```

# save genotype data
```{r}
geno_df <- genotype_df[genotype_df$generation >= 9999 & genotype_df$generation <= 10100, ]
```

```{r}
saveRDS(genotype_df, file = "../r_data/fluc_env_cpsi/genotypes.rds")
```

```{r}
# Later (or on another machine)
geno_df <- readRDS("genotype_data.rds")
```

```{r}
colnames(genotype_df)
```



# load phenotype data
```{r}
regimes <- c("fit", "ave", "ext")  # only non-variacne model has phenotype data

# Top-level folders to search under
folders <- file.path(base_data_folders, "phenotype")

# Helper: extract metadata from phenotype path
extract_geno_metadata <- function(path) {
  pat <- "phenotype/n_(\\d+)_psi_(-?[0-9.]+)_sz_(\\d+)_reg_(fit|ext|ave)_(\\d+)\\.tsv$"
  matches <- regexec(pat, path)
  parts <- regmatches(path, matches)[[1]]

  if (length(parts) != 6) {
    reg_match <- sub(".*_reg_([a-zA-Z0-9]+)_\\d+\\.tsv$", "\\1", path)
    if (!exists("regimes") || !reg_match %in% regimes) return(data.frame())
    warning("Could not extract metadata from path: ", path,
            " with matches: ", paste(parts, collapse = ", "))
    return(data.frame())
  }

  data.frame(
    n          = as.integer(parts[2]),       # "beta" or "psi"
    psi      = as.numeric(parts[3]),
    shift_size = as.integer(parts[4]),
    reg        = parts[5],                 # "fit"|"ext"|"ave"
    rep        = as.integer(parts[6]),
    file_id    = basename(path),
    stringsAsFactors = FALSE
  )
}

# Helper: find the generation key column name in a df
.gen_key <- function(d) {
  if ("tick" %in% names(d)) return("tick")
  if ("generation" %in% names(d)) return("generation")
  # Fallback: first column (last resort)
  names(d)[1]
}

dfs <- lapply(folders, function(folder) {
  if (!dir.exists(folder)) {
    warning("Folder does not exist: ", folder)
    return(NULL)
  }

  file_list <- list.files(
    path = folder,
    pattern = "\\.tsv$",
    full.names = TRUE,
    recursive = TRUE
  )
  if (!length(file_list)) return(NULL)

  pheno_df <- do.call(rbind, lapply(file_list, function(file) {
    # Read phenotype file
    df <- tryCatch(read.table(file, header = TRUE, sep = "\t", check.names = FALSE),
                   error = function(e) NULL)
    if (is.null(df)) {
      warning("Failed to read phenotype: ", file)
      return(NULL)
    }

    meta <- extract_geno_metadata(file)
    if (nrow(meta) == 0) return(NULL)

    # Attach metadata columns
    df$n <- meta$n
    df$psi  <- meta$psi
    df$shift_size <- meta$shift_size
    df$reg        <- meta$reg
    df$rep        <- meta$rep
    df$file_id    <- meta$file_id

    df
  }))

  pheno_df
})

phenotype_df <- do.call(rbind, dfs)

```

# save phenotype data
```{r}
# pheno_df <- phenotype_df[phenotype_df$generation >= 9999 & phenotype_df$generation <= 10100, ]
# print(max(phenotype_df$psis_mean))
# colnames(phenotype_df)

names(phenotype_df)[names(phenotype_df) == "spsi"] <- "psi"
unique(phenotype_df$psi)
```

```{r}
saveRDS(phenotype_df, file = "../r_data/fluc_env_cpsi/phenotypes.rds")
```

```{r}
# Later (or on another machine)
pheno_df <- readRDS("phenotype_data.rds")
```


## load sociality data
```{r}
## -----------------------------------------------
## 1) Pick input folders: use psis/ and/or betas/
## -----------------------------------------------
folders <- file.path(base_data_folders, "psis")

## -----------------------------------------------
## 2) Filename metadata extractor
##    Matches: (psis|betas)/n_<n>_(beta|psi)_<val>_sz_<sz>_reg_(inv|fit|ext|ave)_<rep>.tsv
## -----------------------------------------------
extract_psi_metadata <- function(path) {
  pat <- "psis/n_(\\d+)_psi_(-?[0-9.]+)_sz_(\\d+)_reg_(inv|fit|ext|ave)_(\\d+)\\.tsv$"
  m <- regexec(pat, path)
  parts <- regmatches(path, m)[[1]]
  if (length(parts) != 6) {
    warning("Could not parse metadata from: ", path)
    return(data.frame())
  }
  data.frame(
    n          = as.integer(parts[2]),
    psi      = as.numeric(parts[3]),
    shift_size = as.integer(parts[4]),
    reg        = parts[5],                         # "inv"|"fit"|"ext"|"ave"
    rep        = as.integer(parts[6]),
    file_id    = basename(path),
    stringsAsFactors = FALSE
  )
}

## -----------------------------------------------
## 3) Reader for the column-grouped matrix
##    Assumes: first row = generation numbers (one per column),
##             rows 2.. = values for each individual at that generation
## -----------------------------------------------
dfs <- lapply(folders, function(folder) {
    if (!dir.exists(folder)) {
        warning("Folder does not exist: ", folder)
        next
    }

    file_list <- list.files(
        path = folder,
        pattern = "\\.tsv$",
        full.names = TRUE,
        recursive = TRUE
    )

    # Read and combine all files
    psis_df <- do.call(rbind, lapply(file_list, function(file) {
        df <- tryCatch(read.table(file, header = TRUE, sep = "\t", check.names = FALSE),
                    error = function(e) NULL)
        if (is.null(df)) {
            warning("Failed to read: ", file)
            return(NULL)
        }

        meta <- extract_psi_metadata(file)
        if (nrow(meta) == 0) return(NULL)

    # ---- Locate partner data file with same relative path under 'data' ----
    data_file <- sub("/psis/", "/data/", file, fixed = TRUE)
    have_data <- file.exists(data_file)

    # Default psis_mean is NA; try to fill from data file
    psis_vec <- rep(NA_real_, nrow(df))

    if (have_data) {
      dat <- tryCatch(read.table(data_file, header = TRUE, sep = "\t", check.names = FALSE),
                      error = function(e) NULL)
      if (is.null(dat)) {
        warning("Failed to read data partner: ", data_file)
      } else if (!("psi_mean" %in% names(dat))) {
        warning("Missing 'psi_mean' in data partner: ", data_file)
      } else {
        # Match by generation key
        key_x <- .gen_key(df)
        key_y <- .gen_key(dat)

        kx <- suppressWarnings(as.integer(df[[key_x]]))
        ky <- suppressWarnings(as.integer(dat[[key_y]]))

        ok_y <- is.finite(ky)
        dat_sub <- dat[ok_y, , drop = FALSE]
        ky_sub  <- ky[ok_y]
        # In case of duplicates in partner, keep first per generation
        first_idx <- !duplicated(ky_sub)
        ky_sub <- ky_sub[first_idx]
        psis_lookup <- suppressWarnings(as.numeric(dat_sub$psis_mean[first_idx]))

        m <- match(kx, ky_sub)
        psis_vec <- psis_lookup[m]
      }
    } else {
      warning("Data partner not found for genotype file: ", file,
              " -> expected: ", data_file)
    }

    # Attach the psis_mean column (overwrites if already present)
    df$psis_mean <- psis_vec

        # # Attach metadata columns
        df$n          <- meta$n
        df$shift_size <- meta$shift_size
        df$reg        <- meta$reg
        df$rep        <- meta$rep
        df$file_id    <- meta$file_id
        df$psi    <- meta$psi
        df
    }))
    psis_df <- psis_df[ , sort(names(psis_df))]

    return(psis_df)
})

# ## -----------------------------------------------
# ## 4) Walk folders, read files, attach metadata
# ## -----------------------------------------------
# file_list <- unlist(lapply(in_folders, function(folder)
#   list.files(folder, pattern = "\\.tsv$", full.names = TRUE, recursive = TRUE)
# ), use.names = FALSE)

# dfs <- lapply(file_list, function(f) {
#   meta <- extract_psibeta_metadata(f)
#   if (nrow(meta) == 0) return(NULL)

#   dat <- read_column_grouped(f)
#   if (is.null(dat)) return(NULL)

#   # Attach metadata
#   dat$n          <- meta$n
#   dat$sociality  <- meta$value
#   dat$shift_size <- meta$shift_size
#   dat$reg        <- meta$reg
#   dat$rep        <- meta$rep
#   dat$file_id    <- meta$file_id

#   dat
# })

psis_betas_df <- do.call(rbind, dfs)
```

```{r}
saveRDS(psis_betas_df, file = "../r_data/dsicrete_evolve_sociality/psis.rds")
```

```{r}
# Later (or on another machine)
psis_betas_df <- readRDS("../r_data/dsicrete_evolve_sociality/psis.rds")
```

## load fitness
```{r}
## -----------------------------------------------
## 1) Pick input folders: use psis/ and/or betas/
## -----------------------------------------------
folders <- file.path(base_data_folders, "fitness")

## -----------------------------------------------
## 2) Filename metadata extractor
##    Matches: (psis|betas)/n_<n>_(beta|psi)_<val>_sz_<sz>_reg_(inv|fit|ext|ave)_<rep>.tsv
## -----------------------------------------------
extract_psi_metadata <- function(path) {
  pat <- "fitness/n_(\\d+)_psi_(-?[0-9.]+)_sz_(\\d+)_reg_(inv|fit|ext|ave)_(\\d+)\\.tsv$"
  m <- regexec(pat, path)
  parts <- regmatches(path, m)[[1]]
  if (length(parts) != 6) {
    warning("Could not parse metadata from: ", path)
    return(data.frame())
  }
  data.frame(
    n          = as.integer(parts[2]),
    psi      = as.numeric(parts[3]),
    shift_size = as.integer(parts[4]),
    reg        = parts[5],                         # "inv"|"fit"|"ext"|"ave"
    rep        = as.integer(parts[6]),
    file_id    = basename(path),
    stringsAsFactors = FALSE
  )
}

## -----------------------------------------------
## 3) Reader for the column-grouped matrix
##    Assumes: first row = generation numbers (one per column),
##             rows 2.. = values for each individual at that generation
## -----------------------------------------------
dfs <- lapply(folders, function(folder) {
    if (!dir.exists(folder)) {
        warning("Folder does not exist: ", folder)
        next
    }

    file_list <- list.files(
        path = folder,
        pattern = "\\.tsv$",
        full.names = TRUE,
        recursive = TRUE
    )

    # Read and combine all files
    f_df <- do.call(rbind, lapply(file_list, function(file) {
        df <- tryCatch(read.table(file, header = TRUE, sep = "\t", check.names = FALSE),
                    error = function(e) NULL)
        if (is.null(df)) {
            warning("Failed to read: ", file)
            return(NULL)
        }

        meta <- extract_psi_metadata(file)
        if (nrow(meta) == 0) return(NULL)

            # ---- Locate partner data file with same relative path under 'data' ----
    data_file <- sub("/fitness/", "/data/", file, fixed = TRUE)
    have_data <- file.exists(data_file)

    # Default psis_mean is NA; try to fill from data file
    psis_vec <- rep(NA_real_, nrow(df))

    if (have_data) {
      dat <- tryCatch(read.table(data_file, header = TRUE, sep = "\t", check.names = FALSE),
                      error = function(e) NULL)
      if (is.null(dat)) {
        warning("Failed to read data partner: ", data_file)
      } else if (!("psi_mean" %in% names(dat))) {
        warning("Missing 'psi_mean' in data partner: ", data_file)
      } else {
        # Match by generation key
        key_x <- .gen_key(df)
        key_y <- .gen_key(dat)

        kx <- suppressWarnings(as.integer(df[[key_x]]))
        ky <- suppressWarnings(as.integer(dat[[key_y]]))

        ok_y <- is.finite(ky)
        dat_sub <- dat[ok_y, , drop = FALSE]
        ky_sub  <- ky[ok_y]
        # In case of duplicates in partner, keep first per generation
        first_idx <- !duplicated(ky_sub)
        ky_sub <- ky_sub[first_idx]
        psis_lookup <- suppressWarnings(as.numeric(dat_sub$psis_mean[first_idx]))

        m <- match(kx, ky_sub)
        psis_vec <- psis_lookup[m]
      }
    } else {
      warning("Data partner not found for genotype file: ", file,
              " -> expected: ", data_file)
    }

    # Attach the psis_mean column (overwrites if already present)
    df$psis_mean <- psis_vec

        # # Attach metadata columns
        df$n          <- meta$n
        df$shift_size <- meta$shift_size
        df$reg        <- meta$reg
        df$rep        <- meta$rep
        df$file_id    <- meta$file_id
        df$psi    <- meta$psi
        df
    }))
    f_df <- f_df[ , sort(names(f_df))]

    return(f_df)
})

fitness_df <- do.call(rbind, dfs)
```


```{r}
saveRDS(fitness_df, file = "../r_data/dsicrete_evolve_sociality/fitnesses.rds")
```
