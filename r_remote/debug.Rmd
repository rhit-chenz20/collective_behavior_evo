---
title: "plot genotype, phenotype and effect size data"
author: "Andrea Chen"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
setwd("/workdir/zc524/collective_behavior_evo/r_remote")
base_data_folder <- "../data/n_group_translational"
base_plot_folder <- "../r_plots/n_group_translational"
target_psi <- c(0.0, 0.3, 0.5, 0.7, 0.9)
regimes <- c("fit", "ave")  # "ave" = average, "fit" = fitness-based
```

# load GENOTYPE data
```{r}
# Set the top-level folder
folder <- paste0(base_data_folder, "/genotype")

# List all .tsv files recursively
file_list <- list.files(
  path = folder,
  pattern = "\\.tsv$",
  full.names = TRUE,
  recursive = TRUE
)

# Function to extract metadata from path
# Matches: genotype/n_<n>_psi_<psi>_sz_<sz>_reg_<ave|fit>_<rep>.tsv
extract_geno_metadata <- function(path) {
  pat <- "genotype/n_(\\d+)_psi_(-?[0-9.]+)_sz_(\\d+)_reg_(ave|fit)_(\\d+)\\.tsv"
  matches <- regexec(pat, path)
  parts <- regmatches(path, matches)[[1]]

  if (length(parts) != 6) {
    warning("Could not extract metadata from path: ", path,
            " with matches: ", paste(parts, collapse = ", "))
    return(data.frame())
  }

  data.frame(
    n    = as.integer(parts[2]),
    psi  = as.numeric(parts[3]),
    sz   = as.integer(parts[4]),
    reg  = parts[5],             # "ave" or "fit"
    rep  = as.integer(parts[6]),
    stringsAsFactors = FALSE
  )
}

# Helper: get shift_size from the companion "data" file (optimum at generation == 10001)
get_shift_from_data <- function(geno_file, base_data_folder, opt_gen = 10001L) {
  # Mirror the path: .../genotype/... -> .../data/...
  data_path <- sub("/genotype/", "/data/", geno_file, fixed = TRUE)
  if (!file.exists(data_path)) {
    data_path <- file.path(base_data_folder, "data", basename(geno_file))
  }

  if (!file.exists(data_path)) {
    warning("Data file not found for ", basename(geno_file), " (looked for: ", data_path, ")")
    return(NA_real_)
  }

  d <- tryCatch(read.table(data_path, header = TRUE, sep = "\t"), error = function(e) NULL)
  if (is.null(d)) {
    warning("Failed to read data file: ", data_path)
    return(NA_real_)
  }
  if (!("tick" %in% names(d)) || !("optimum" %in% names(d))) {
    warning("Missing 'tick' or 'optimum' column in data file: ", data_path)
    return(NA_real_)
  }

  row10001 <- d[d$tick == opt_gen, , drop = FALSE]
  if (nrow(row10001) < 1) {
    warning("No row with tick == ", opt_gen, " in ", data_path)
    return(NA_real_)
  }

  val <- suppressWarnings(as.numeric(row10001$optimum[1]))
  if (!is.finite(val)) {
    warning("Non-numeric 'optimum' at generation ", opt_gen, " in ", data_path)
    return(NA_real_)
  }
  val
}

# Read and combine all files
opt_gen <- 10001L
genotype_df <- do.call(rbind, lapply(file_list, function(file) {
  df <- tryCatch(read.table(file, header = TRUE, sep = "\t"), error = function(e) NULL)
  if (is.null(df)) {
    warning("Failed to read genotype file: ", file)
    return(NULL)
  }

  meta <- extract_geno_metadata(file)
  if (nrow(meta) == 0) return(NULL)

  # Attach metadata
  df$rep        <- meta$rep
  df$psi        <- meta$psi
  df$n          <- meta$n
  df$reg        <- meta$reg        # <- new column ("ave" or "fit")
  df$sz_orig    <- meta$sz         # preserve original sz
  df$shift_size <- if (meta$sz == 0L) get_shift_from_data(file, base_data_folder, opt_gen) else meta$sz
  df$file_id    <- basename(file)
  df
}))

```




```{r}
## --- Assumptions ---
## - 'genotype_df' already exists with columns:
##   generation, metadata cols (n, psi, rep, reg, sz_orig, shift_size, file_id), and X* genotype columns.
## - 'base_plot_folder' exists in your environment (string path). If not, set it before running.

## Helper: pick the fittest individual (highest PDF under N(0, sqrt(2000)^2)) from each 3-person group
pick_triplet_winners <- function(x_vals, group_size = 3, sd_val = sqrt(2000), seed = NULL) {
  # x_vals: numeric vector of genotypes for a single generation (one row of X* values)
  x <- as.numeric(x_vals)
  x <- x[is.finite(x)]
  n_ind <- length(x)
  if (n_ind < group_size) return(numeric(0))

  if (!is.null(seed)) set.seed(seed)
  # Random permutation of individuals
  perm_idx <- sample.int(n_ind)
  # Keep only a multiple of 3
  keep <- floor(n_ind / group_size) * group_size
  perm_idx <- perm_idx[seq_len(keep)]

  # Form groups: each column is a group of size 3
  grp_mat <- matrix(perm_idx, nrow = group_size, byrow = TRUE)

  # Compute fitness (PDF values) per group member, choose best per group
  winners <- numeric(ncol(grp_mat))
  for (j in seq_len(ncol(grp_mat))) {
    inds <- grp_mat[, j]
    fits <- dnorm(x[inds], mean = 0, sd = sd_val)
    winners[j] <- x[inds[which.max(fits)]]
  }
  winners
}

## Plotting function for one row (i.e., one subset)
plot_triplet_winners <- function(row_df, xcols, out_dir, seed = NULL,
                                 num_bins = 60) {
  # Extract metadata for naming
  n_val    <- row_df$n[1]
  psi_val  <- row_df$psi[1]
  reg_val  <- row_df$reg[1]
  rep_val  <- row_df$rep[1]
  sh_val   <- row_df$shift_size[1]
  file_id  <- row_df$file_id[1]

  # Extract the genotype vector for this row
  x_vec <- unlist(row_df[ , xcols], use.names = FALSE)

  winners <- pick_triplet_winners(x_vec, group_size = 3, sd_val = sqrt(2000), seed = seed)

  # Nothing to plot if no winners (e.g., <3 individuals)
  if (length(winners) == 0) {
    warning(sprintf("No winners (insufficient individuals) for %s", file_id))
    return(invisible(NULL))
  }

  # Build filename
  fname <- sprintf("triplet_winners_gen10000_n_%s_psi_%s_reg_%s_shift_%s_rep_%s.png",
                   n_val, psi_val, reg_val, sh_val, rep_val)
  fpath <- file.path(out_dir, fname)

  # Define bins based only on the data in this figure (your request)
  rng <- range(winners, finite = TRUE)
  breaks <- seq(rng[1], rng[2], length.out = num_bins + 1)

  png(fpath, width = 1200, height = 900, res = 120)
  par(mar = c(4.5, 4.5, 4.2, 1.2))
  h <- hist(winners,
            breaks = breaks,
            main = sprintf("Fittest in 3-person groups — gen=10000 | n=%s, psi=%s, reg=%s, shift=%s, rep=%s\n(%d groups, 1 winner each)",
                           n_val, psi_val, reg_val, sh_val, rep_val, length(winners)),
            xlab = "Genotype of group winner",
            ylab = "Frequency")
  # Add density curve and rug for detail
  if (length(unique(winners)) > 1) {
    lines(density(winners), lwd = 2)
  }
  rug(winners)
  abline(v = 0, lty = 2)
  dev.off()

  invisible(fpath)
}

## --- Driver: filter to generation 10000 and plot for each row ---
gen_target <- 10000
df_g <- subset(genotype_df, generation == gen_target & regimes == "fit")

if (!nrow(df_g)) {
  stop("No rows found with generation == 10000 in genotype_df.")
}

# Identify genotype columns
xcols <- grep("^X", names(df_g), value = TRUE)
if (!length(xcols)) stop("No X* genotype columns found in genotype_df.")

# Output directory
out_dir <- file.path(base_plot_folder, "triplet_winners_gen10000")
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)

# Optional: set a seed for reproducible grouping (comment out if you want fresh random groups each run)
seed_for_groups <- 42

# Loop over each row (each may correspond to a distinct n/psi/reg/rep/file)
for (i in seq_len(nrow(df_g))) {
  plot_triplet_winners(df_g[i, , drop = FALSE], xcols, out_dir, seed = seed_for_groups)
}

```



# load PHENOTYPE data
```{r}
pheno_folder <- file.path(base_data_folder, "phenotype")

# List all phenotype files
pheno_files <- list.files(
  path = pheno_folder,
  pattern = "\\.tsv$",
  full.names = TRUE,
  recursive = TRUE
)

# Parse metadata from phenotype file path
# Matches: phenotype/n_<n>_psi_<psi>_sz_<sz>_reg_<ave|fit>_<rep>.tsv
extract_pheno_metadata <- function(path) {
  m <- regexec("phenotype/n_(\\d+)_psi_(-?[0-9.]+)_sz_(\\d+)_reg_(ave|fit)_(\\d+)\\.tsv", path)
  parts <- regmatches(path, m)[[1]]
  if (length(parts) != 6) {
    warning("Could not extract metadata from path: ", path, " parts: ", paste(parts, collapse=", "))
    return(data.frame())
  }
  data.frame(
    n   = as.integer(parts[2]),
    psi = as.numeric(parts[3]),
    sz  = as.integer(parts[4]),
    reg = parts[5],                 # "ave" or "fit"
    rep = as.integer(parts[6]),
    stringsAsFactors = FALSE
  )
}

# Get shift_size from companion "data" file (optimum at generation == 10001)
pheno_get_shift_from_data <- function(pheno_file, base_data_folder, opt_gen = 10001L) {
  # Mirror .../phenotype/... -> .../data/...
  data_path <- sub("/phenotype/", "/data/", pheno_file, fixed = TRUE)
  if (!file.exists(data_path)) {
    data_path <- file.path(base_data_folder, "data", basename(pheno_file))
  }
  if (!file.exists(data_path)) {
    warning("Data file not found for ", basename(pheno_file), " (looked for: ", data_path, ")")
    return(NA_real_)
  }

  d <- tryCatch(read.table(data_path, header = TRUE, sep = "\t"), error = function(e) NULL)
  if (is.null(d)) {
    warning("Failed to read data file: ", data_path)
    return(NA_real_)
  }
  if (!all(c("tick", "optimum") %in% names(d))) {
    warning("Missing 'tick' or 'optimum' in data file: ", data_path)
    return(NA_real_)
  }

  row10001 <- d[d$tick == opt_gen, , drop = FALSE]
  if (nrow(row10001) < 1) {
    warning("No row with tick == ", opt_gen, " in ", data_path)
    return(NA_real_)
  }

  val <- suppressWarnings(as.numeric(row10001$optimum[1]))
  if (!is.finite(val)) {
    warning("Non-numeric 'optimum' at generation ", opt_gen, " in ", data_path)
    return(NA_real_)
  }
  val
}

# -------- Load phenotype_df (no name collisions with genotype) --------
opt_gen <- 10001L
phenotype_df <- do.call(rbind, lapply(pheno_files, function(file) {
  df <- tryCatch(read.table(file, header = TRUE, sep = "\t"), error = function(e) NULL)
  if (is.null(df)) {
    warning("Failed to read phenotype file: ", file)
    return(NULL)
  }

  meta <- extract_pheno_metadata(file)
  if (nrow(meta) == 0) return(NULL)

  # Attach metadata (distinct columns; keep original sz for pooling)
  df$rep        <- meta$rep
  df$psi        <- meta$psi
  df$n          <- meta$n
  df$reg        <- meta$reg          # <- new column ("ave" or "fit")
  df$sz_orig    <- meta$sz
  df$shift_size <- if (meta$sz == 0L) pheno_get_shift_from_data(file, base_data_folder, opt_gen) else meta$sz
  df$file_id    <- basename(file)
  df
}))

```

```{r}
## ------- Config -------
gen_target <- 9999     # set your generation here
num_bins   <- 60
out_dir    <- file.path(base_plot_folder, sprintf("multi_panel_gen%s_n8_fit_sz100", gen_target))
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)

## ------- Helpers -------
get_xcols <- function(df) {
  xcols <- grep("^X", names(df), value = TRUE)
  if (!length(xcols)) stop("No X* columns found.")
  xcols
}

# Build common breaks across the selected subset (for comparability within a figure)
common_breaks_for_subset <- function(df_sel, xcols, num_bins) {
  vals <- as.numeric(unlist(df_sel[, xcols], use.names = FALSE))
  vals <- vals[is.finite(vals)]
  if (!length(vals)) stop("No finite X* values found for break calculation.")
  rng <- range(vals)
  if (rng[1] == rng[2]) {
    # expand a tiny bit to avoid zero-width bins
    eps <- max(1e-8, abs(rng[1]) * 1e-6)
    rng <- c(rng[1] - eps, rng[2] + eps)
  }
  seq(rng[1], rng[2], length.out = num_bins + 1)
}

plot_3x3_for_reps <- function(df, which_df = c("genotype","phenotype"),
                              gen_target, out_dir, num_bins = 60) {
  which_df <- match.arg(which_df)

  # Filter subset
  df_sel <- subset(df,
                   generation == gen_target &
                   psi == 0.9 &
                   reg == "fit" &
                   n == 8 &
                   sz_orig == 100)
  if (!nrow(df_sel)) {
    stop(sprintf("[%s] No rows match the filter for generation=%s, psi=0.9, reg=fit, n=8, sz_orig=100.",
                 which_df, gen_target))
  }

  xcols <- get_xcols(df_sel)
  # Common breaks for this figure
  brks  <- common_breaks_for_subset(df_sel, xcols, num_bins)

  # Output PNG
  fpng <- file.path(
    out_dir,
    sprintf("%s_distribution_gen%s_n8_fit_sz100_reps1to9.png", which_df, gen_target)
  )
  png(fpng, width = 1800, height = 1500, res = 140)
  op <- par(mfrow = c(3, 3), mar = c(3.8, 3.8, 3.3, 1.0), oma = c(0,0,3.5,0))

  reps <- 1:9
  for (r in reps) {
    row_r <- subset(df_sel, rep == r)
    if (!nrow(row_r)) {
      plot.new()
      title(main = sprintf("rep = %d (no data)", r), cex.main = 1.1)
      next
    }
    x <- as.numeric(unlist(row_r[, xcols], use.names = FALSE))
    x <- x[is.finite(x)]
    if (!length(x)) {
      plot.new()
      title(main = sprintf("rep = %d (no finite data)", r), cex.main = 1.1)
      next
    }
    h <- hist(x,
              breaks = brks,
              freq = FALSE,
              main = sprintf("rep = %d", r),
              xlab = "", ylab = "")
    if (length(unique(x)) > 1) lines(density(x), lwd = 2)
    rug(x)
    abline(v = 0, lty = 2)
    mtext(side = 1, line = 2.4, text = "Value")
    mtext(side = 2, line = 2.4, text = "Density")
  }

  # Overall title
  mtext(sprintf("%s distribution — gen=%s, psi=0.9, reg=fit, n=8, sz_orig=100 (3×3 reps)",
                tools::toTitleCase(which_df), gen_target),
        outer = TRUE, cex = 1.3)
  par(op)
  dev.off()

  message(sprintf("[%s] Saved: %s", which_df, fpng))
}

## ------- Run for genotype and phenotype -------
plot_3x3_for_reps(genotype_df,  which_df = "genotype",  gen_target = gen_target, out_dir = out_dir, num_bins = num_bins)
plot_3x3_for_reps(phenotype_df, which_df = "phenotype", gen_target = gen_target, out_dir = out_dir, num_bins = num_bins)

```

## plot fitness data
```{r}
## ---------------- Config ----------------
gen_target <- 10000
psi_target <- 0.9
reg_target <- "fit"
n_target   <- 8
sz_target  <- 100
num_bins   <- 60
seed_base  <- 42
sd_norm    <- sqrt(2000)

out_dir <- file.path(
  base_plot_folder,
  sprintf("triplet_pheno_and_fitness_gen%s_n%d_%s_sz%d", gen_target, n_target, reg_target, sz_target)
)
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)

## -------------- Helpers -----------------
get_xcols <- function(df) {
  xcols <- grep("^X", names(df), value = TRUE)
  if (!length(xcols)) stop("No X* columns found.")
  xcols
}

# Random disjoint groups of size g; matrix with g rows, each column a group
make_groups <- function(n_ind, g = 3, seed = NULL) {
  if (!is.null(seed)) set.seed(seed)
  if (n_ind < g) return(matrix(integer(0), nrow = g, ncol = 0))
  perm <- sample.int(n_ind)
  keep <- floor(n_ind / g) * g
  matrix(perm[seq_len(keep)], nrow = g, byrow = TRUE)
}

# For one row (one rep): compute triplet-based phenotype and fitness for all grouped individuals
compute_triplet_pheno_and_fitness <- function(a_vec, psi, sd_fit = sqrt(2000), seed = NULL) {
  a <- as.numeric(a_vec)
  a <- a[is.finite(a)]
  n_ind <- length(a)
  if (n_ind < 3) return(list(phenotype = numeric(0), fitness = numeric(0)))

  grp <- make_groups(n_ind, g = 3, seed = seed)
  if (ncol(grp) == 0) return(list(phenotype = numeric(0), fitness = numeric(0)))

  # Winner per group by Normal PDF on raw genotype a
  winners_idx <- integer(ncol(grp))
  for (j in seq_len(ncol(grp))) {
    inds <- grp[, j]
    fits <- dnorm(a[inds], mean = 0, sd = sd_fit)
    winners_idx[j] <- inds[which.max(fits)]
  }

  # Map each individual to group's best genotype
  a_best_by_group <- a[winners_idx]         # length = #groups
  a_best_rep      <- rep(a_best_by_group, each = 3)
  a_grouped       <- a[as.vector(grp)]

  # Phenotype from the linear combo
  p_grouped <- a_grouped * (1 - psi) + psi * a_best_rep

  # Fitness = Normal PDF evaluated on phenotype
  w_grouped <- dnorm(p_grouped, mean = 0, sd = sd_fit)

  list(phenotype = p_grouped, fitness = w_grouped)
}

# Shared breaks across reps for comparability
common_breaks_across_reps <- function(values_list, num_bins = 60) {
  all_vals <- unlist(values_list, use.names = FALSE)
  all_vals <- all_vals[is.finite(all_vals)]
  if (!length(all_vals)) stop("No finite values to set common breaks.")
  rng <- range(all_vals)
  if (rng[1] == rng[2]) {
    eps <- max(1e-8, abs(rng[1]) * 1e-6)
    rng <- c(rng[1] - eps, rng[2] + eps)
  }
  seq(rng[1], rng[2], length.out = num_bins + 1)
}

## --------- Precompute per-rep vectors from genotype_df ----------
subset_geno <- subset(genotype_df,
                      generation == gen_target &
                      psi == psi_target &
                      reg == reg_target &
                      n == n_target &
                      sz_orig == sz_target)
if (!nrow(subset_geno)) stop("No rows in genotype_df match the required filter.")

xcols <- get_xcols(subset_geno)

phenos_by_rep  <- vector("list", 9)
fitness_by_rep <- vector("list", 9)

for (r in 1:9) {
  row_r <- subset(subset_geno, rep == r)
  if (!nrow(row_r)) { phenos_by_rep[[r]] <- numeric(0); fitness_by_rep[[r]] <- numeric(0); next }
  a_vec <- unlist(row_r[, xcols], use.names = FALSE)
  vals  <- compute_triplet_pheno_and_fitness(a_vec, psi = psi_target, sd_fit = sd_norm, seed = seed_base + r)
  phenos_by_rep[[r]]  <- vals$phenotype
  fitness_by_rep[[r]] <- vals$fitness
}

# Shared bins for each figure
brks_pheno   <- common_breaks_across_reps(phenos_by_rep,  num_bins = num_bins)
brks_fitness <- common_breaks_across_reps(fitness_by_rep, num_bins = num_bins)

## ---------------- Plot: Phenotype (3×3) ----------------
fpng_pheno <- file.path(out_dir,
                        sprintf("phenotype_triplet_based_gen%s_n%d_%s_sz%d_reps1to9.png",
                                gen_target, n_target, reg_target, sz_target))
png(fpng_pheno, width = 1800, height = 1500, res = 140)
op <- par(mfrow = c(3, 3), mar = c(3.8, 3.8, 3.3, 1.0), oma = c(0,0,3.5,0))

for (r in 1:9) {
  x <- phenos_by_rep[[r]]
  if (!length(x)) { plot.new(); title(main = sprintf("rep = %d (no data)", r)); next }
  hist(x, breaks = brks_pheno, freq = FALSE,
       main = sprintf("rep = %d", r), xlab = "", ylab = "")
  if (length(unique(x)) > 1) lines(density(x), lwd = 2)
  rug(x)
  abline(v = 0, lty = 2)
  mtext(side = 1, line = 2.4, text = "Phenotype value")
  mtext(side = 2, line = 2.4, text = "Density")
}
mtext(sprintf("Triplet-based phenotype distribution — gen=%s, psi=%.1f, reg=%s, n=%d, sz_orig=%d",
              gen_target, psi_target, reg_target, n_target, sz_target),
      outer = TRUE, cex = 1.3)
par(op); dev.off()
message(sprintf("Saved: %s", fpng_pheno))

## ---------------- Plot: Fitness (3×3) ----------------
fpng_fit <- file.path(out_dir,
                      sprintf("fitness_from_phenotype_gen%s_n%d_%s_sz%d_reps1to9.png",
                              gen_target, n_target, reg_target, sz_target))
png(fpng_fit, width = 1800, height = 1500, res = 140)
op <- par(mfrow = c(3, 3), mar = c(3.8, 3.8, 3.3, 1.0), oma = c(0,0,3.5,0))

for (r in 1:9) {
  w <- fitness_by_rep[[r]]
  if (!length(w)) { plot.new(); title(main = sprintf("rep = %d (no data)", r)); next }
  hist(w, breaks = brks_fitness, freq = FALSE,
       main = sprintf("rep = %d", r), xlab = "", ylab = "")
  if (length(unique(w)) > 1) lines(density(w), lwd = 2)
  rug(w)
  abline(v = 0, lty = 2)
  mtext(side = 1, line = 2.4, text = "Fitness = dnorm(phenotype, 0, √2000)")
  mtext(side = 2, line = 2.4, text = "Density")
}
mtext(sprintf("Fitness distribution (evaluated on phenotype) — gen=%s, psi=%.1f, reg=%s, n=%d, sz_orig=%d",
              gen_target, psi_target, reg_target, n_target, sz_target),
      outer = TRUE, cex = 1.3)
par(op); dev.off()
message(sprintf("Saved: %s", fpng_fit))

```




